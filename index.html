<!DOCTYPE html>
<html>
  <head>
    <title>Ajechess</title>
    <script>
      class Piece {
        constructor(isWhite, image) {
          this.isWhite = isWhite;
          this.image = "src/ajechess/iconos/" + (isWhite ? "blanco" : "negro")
            + "/" + image + ".png";
          this.jumps = [];
          this.directions = [];
        }
      }

      class Pawn extends Piece {
        constructor(isWhite) {
          super(isWhite, "peon");
          var direction = isWhite ? -1 : 1;
          this.jumps = [[1, direction], [-1, direction]];
        }
      }

      class Bishop extends Piece {
        constructor(isWhite) {
          super(isWhite, "alfil");
          this.directions = [[1, 1], [1, -1], [-1, 1], [-1, -1]];
        }
      }

      class Knight extends Piece {
        constructor(isWhite) {
          super(isWhite, "caballo");
          this.jumps = [[2, 1], [2, -1], [1, 2], [1, -2],
            [-2, 1], [-2, -1], [-1, 2], [-1, -2]];
        }
      }

      class Rook extends Piece {
        constructor(isWhite) {
          super(isWhite, "torre");
          this.directions = [[1, 0], [-1, 0], [0, 1], [0, -1]];
        }
      }

      class Queen extends Piece {
        constructor(isWhite) {
          super(isWhite, "dama");
          this.directions = [[1, 1], [1, -1], [-1, 1], [-1, -1],
            [1, 0], [-1, 0], [0, 1], [0, -1]];
        }
      }

      class King extends Piece {
        constructor(isWhite) {
          super(isWhite, "rey");
          this.jumps = [[1, 1], [1, 0], [1, -1], [0, 1],
            [0, -1], [-1, 1], [-1, 0], [-1, -1]];
        }
      }

      function rgb(color) {
        return "rgb(" + color[0] + "," + color[1] + "," + color[2] + ")";
      }

      function initBoard() {
        cellWidth = 64;
        numCells = 8;
        fontSize = 16;
        margin = 4;
        maxColor = 255;
        colorSlope = 32;
        c = document.getElementById("canvium");
        c.width = numCells * cellWidth;
        c.height = numCells * cellWidth;
        ctx = c.getContext("2d");
        ctx.font = "16px monospace";
        board = [
          [new Rook(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Rook(true)],
          [new Knight(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Knight(true)],
          [new Bishop(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Bishop(true)],
          [new Queen(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Queen(true)],
          [new King(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new King(true)],
          [new Bishop(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Bishop(true)],
          [new Knight(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Knight(true)],
          [new Rook(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Rook(true)]
        ];
        whiteThreat = [
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0]
        ];
        blackThreat = [
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0]
        ];
      }

      function calculateThreat() {
        for (var i = 0; i < numCells; ++i) {
          for (var j = 0; j < numCells; ++j) {
            var piece = board[i][j];
            if (piece) {
              for (jump of piece.jumps) {
                jumpX = i + jump[0];
                jumpY = j + jump[1];
                if (jumpX >= 0 && jumpX < numCells
                  && jumpY >= 0 && jumpY < numCells) {
                  if (piece.isWhite) {
                    ++whiteThreat[jumpX][jumpY];
                  } else {
                    ++blackThreat[jumpX][jumpY];
                  }
                }
              }
              for (direction of piece.directions) {
                for (var k = 1; k < numCells; ++k){
                  dirX = i + k * direction[0];
                  dirY = j + k * direction[1];
                  if (dirX < 0 || dirX >= numCells
                    || dirY < 0 || dirY >= numCells) {
                    break;
                  }
                  if (piece.isWhite) {
                    ++whiteThreat[dirX][dirY];
                  } else {
                    ++blackThreat[dirX][dirY];
                  }
                  if (board[dirX][dirY]) {
                    break;
                  }
                }
              }
            }
          }
        }
      }

      function onloadDraw(image, i, j) {
        var localImage = image;
        var localI = i;
        var localJ = j;
        return function () {
          ctx.drawImage(localImage, localI * cellWidth,
            localJ * cellWidth, cellWidth, cellWidth);
        }
      }

      function drawBoard() {
        for (var i = 0; i < numCells; ++i) {
          for (var j = 0; j < numCells; ++j) {
            var cellX = i * cellWidth;
            var cellY = j * cellWidth;
            ctx.strokeRect(cellX, cellY, cellWidth, cellWidth);
            var wt = whiteThreat[i][j];
            var bt = blackThreat[i][j];
            ctx.fillStyle = rgb([
              maxColor - colorSlope * wt,
              maxColor - colorSlope * (wt + bt),
              maxColor - colorSlope * bt]);
            ctx.fillRect(cellX + 1, cellY + 1, cellWidth - 2, cellWidth - 2);
            var textX = cellX + margin;
            ctx.fillStyle = rgb([0, 0, maxColor]);
            ctx.fillText(wt.toString(), textX, cellY + cellWidth - margin);
            ctx.fillStyle = rgb([maxColor, 0, 0]);
            ctx.fillText(bt.toString(), textX, cellY + fontSize);
            var piece = board[i][j];
            if (piece) {
              var image = new Image();
              image.onload = onloadDraw(image, i, j);
              image.src = piece.image;
            }
          }
        }
      }

      function onload() {
        initBoard();
        calculateThreat();
        drawBoard();
      }
    </script>
  </head>
  <body onload="onload()">
    <canvas id="canvium"></canvas>
  </body>
</html>
