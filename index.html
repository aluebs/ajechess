<!DOCTYPE html>
<html>
  <head>
    <title>Ajechess</title>
    <script>
      class Piece {
        constructor(isWhite, image) {
          this.image = "src/ajechess/iconos/" + (isWhite ? "blanco" : "negro")
            + "/" + image + ".png";
        }
      }

      class Pawn extends Piece {
        constructor(isWhite) {
          super(isWhite, "peon");
        }
      }

      class Bishop extends Piece {
        constructor(isWhite) {
          super(isWhite, "alfil");
        }
      }

      class Knight extends Piece {
        constructor(isWhite) {
          super(isWhite, "caballo");
        }
      }

      class Rook extends Piece {
        constructor(isWhite) {
          super(isWhite, "torre");
        }
      }

      class Queen extends Piece {
        constructor(isWhite) {
          super(isWhite, "dama");
        }
      }

      class King extends Piece {
        constructor(isWhite) {
          super(isWhite, "rey");
        }
      }

      function rgb(color) {
        return "rgb(" + color[0] + "," + color[1] + "," + color[2] + ")";
      }

      function canvas2Array(cvs) {
        var imgData = ctx.getImageData(0, 0, cvs.width, cvs.height).data;
        var imgArray = new Array(cvs.width);
        for (var i = 0; i < imgArray.length; ++i) {
          imgArray[i] = new Array(cvs.height);
          for (var j = 0; j < imgArray[i].length; ++j) {
            imgArray[i][j] = new Array(3);
            for (var k = 0; k < 3; ++k) {
              imgArray[i][j][k] = imgData[4 * (i + j * cvs.width) + k];
            }
          }
        }
        return imgArray;
      }

      function array2Canvas(imgArray) {
        var imgData = ctx.createImageData(imgArray.length, imgArray[0].length);
        for (var i = 0; i < imgArray.length; ++i) {
          for (var j = 0; j < imgArray[i].length; ++j) {
            for (var k = 0; k < 3; ++k) {
              imgData.data[4 * (i + j * imgArray.length) + k] =
                imgArray[i][j][k];
            }
            imgData.data[4 * (i + j * imgArray.length) + 3] = 255;
          }
        }
        ctx.putImageData(imgData, 0, 0);
      }

      function initBoard() {
        cellWidth = 64;
        numCells = 8;
        c = document.getElementById("canvium");
        c.width = numCells * cellWidth;
        c.height = numCells * cellWidth;
        ctx = c.getContext("2d");
        boardArray = canvas2Array(c);
        board = [
          [new Rook(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Rook(true)],
          [new Knight(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Knight(true)],
          [new Bishop(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Bishop(true)],
          [new Queen(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Queen(true)],
          [new King(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new King(true)],
          [new Bishop(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Bishop(true)],
          [new Knight(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Knight(true)],
          [new Rook(false), new Pawn(false), null, null,
            null, null, new Pawn(true), new Rook(true)]
        ];
      }

      function onloadDraw(image, i, j) {
        var localImage = image;
        var localI = i;
        var localJ = j;
        return function () {
          ctx.drawImage(localImage, localI * cellWidth,
            localJ * cellWidth, cellWidth, cellWidth);
        }
      }

      function drawCheckerBoard() {
        for (var i = 0; i < numCells; ++i) {
          for (var j = 0; j < numCells; ++j) {
            ctx.fillStyle =
              rgb((i + j) % 2 ? [192, 192, 192] : [255, 255, 255]);
            ctx.fillRect(i * cellWidth, j * cellWidth, cellWidth, cellWidth);
            if (board[i][j]) {
              var image = new Image();
              image.onload = onloadDraw(image, i, j);
              image.src = board[i][j].image;
            }
          }
        }
      }

      function onload() {
        initBoard();
        drawCheckerBoard();
      }
    </script>
  </head>
  <body onload="onload()">
    <canvas id="canvium"></canvas>
  </body>
</html>
